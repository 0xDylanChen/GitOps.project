name: CI
on:
  push:
    tags:
        - 'v*'
    paths-ignore:
      - 'k8s/**'
      - 'GitOps.md'
      - README.md

jobs:
    build-and-push:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v3
          

        - name: Log in to Docker Hub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Build and push Docker image
          uses: docker/build-push-action@v4
          with:
            context: .
            push: true
            tags: luck667986/devops-portfolio-api:${{ github.sha }}

        - name: Update k8S manifest
          run: |
            
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git config --global user.name "github-actions[bot]"
            
            sed -i 's|image: luck667986/devops-portfolio-api:.*|image: luck667986/devops-portfolio-api:${{ github.sha }}|g' k8s/deploy.yaml

            git add k8s/deploy.yaml
            git commit -m "ci: update image tag to ${{ github.sha }}" || echo "No changes to commit"
            git push origin HEAD:main 
